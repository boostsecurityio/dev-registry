api_version: 1.0

id: boostsecurityio/trivy-sbom
name: BoostSecurity Trivy (FS SBOM)
namespace: boostsecurityio/trivy-sbom
scan_types:
  - sbom

config:
  support_diff_scan: false

setup:
  - name: download trivy
    environment:
      VERSION: 0.48.2
      LINUX_X86_64_SHA: 2820ce6c8314ac39d3d9f470322506d029fe5cb5cbce12a826968f9bcc68c783
      LINUX_ARM64_SHA: 3a04f78d66d0920a28af17673dd9d993decfc6186a64c3d4385ef40dcc58c360
      MACOS_X86_64_SHA: 2a7889e845d0b8a7b006832c28701c1522c0c561a28591166ae6ced8a8c0ac85
      MACOS_ARM64_SHA: c2a3a05b7a34241160d859cf2c950de7f8ffd47e59acbc275c92611297b7ac08
    run: |
      BINARY_URL="https://github.com/aquasecurity/trivy/releases/download/v${VERSION}"
      ARCH=$(uname -m)

      case "$(uname -sm)" in
        "Linux x86_64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-64bit.tar.gz"
          SHA="${LINUX_X86_64_SHA} trivy.tgz"
          ;;
        "Linux aarch64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-ARM64.tar.gz"
          SHA="${LINUX_ARM64_SHA} trivy.tgz"
          ;;
        "Darwin x86_64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_macOS-64bit.tar.gz"
          SHA="${MACOS_X86_64_SHA} trivy.tgz"
          ;;
        "Darwin arm64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_macOS-ARM64.tar.gz"
          SHA="${MACOS_ARM64_SHA} trivy.tgz"
          ;;
        *)
          echo "Unsupported machine: ${OPTARG}"
          exit 1
          ;;
      esac

      curl -o trivy.tgz -fsSL "${BINARY_URL}"
      echo "${SHA}" | sha256sum --check

      tar --no-same-owner -zxf trivy.tgz trivy
      rm trivy.tgz
      chmod +x trivy

steps:
  - scan:
      command:
        run: |
            $SETUP_PATH/trivy fs --format=cyclonedx --license-full --cache-dir=/tmp/trivy/ .
      format: cyclonedx
      post-processor:
        docker:
          image: public.ecr.aws/boostsecurityio/boost-scanner-trivy-sbom:2077b09@sha256:9acea8e0566becbbf19a51b7de326cda23d124254091f38cf5e2132f298a1301
          command: process
          environment:
            PYTHONIOENCODING: utf-8
