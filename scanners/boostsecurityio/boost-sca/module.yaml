api_version: 1.0

id: boostsecurityio/boost-sca
name: BoostSecurity SCA
namespace: boostsecurityio/boost-sca
scan_types:
  - sca
  - license

config:
  require_full_repo: true
  support_diff_scan: true

setup:
  - name: download trivy
    environment:
      VERSION: 0.51.4
      LINUX_X86_64_SHA: eee127e93ed40e8f1c7bc2baa062a2635b01346a287046207d186c14b7a33af3
      LINUX_ARM64_SHA: 9f8662f99478e4e13f4f20acaabd148057e60f8b7d886d7bb54bacf9793865df
      MACOS_X86_64_SHA: 9c04716f984308798f04292c692d8dde6d0a719dd518459538eac11fd8ea6daa
      MACOS_ARM64_SHA: d46302eb3545b04ae8684a0f5f29d6e108ae45e094189c2e4353626f0bf1b8c6
    run: |
      BINARY_URL="https://github.com/aquasecurity/trivy/releases/download/v${VERSION}"
      ARCH=$(uname -m)

      case "$(uname -sm)" in
        "Linux x86_64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-64bit.tar.gz"
          SHA="${LINUX_X86_64_SHA} trivy.tgz"
          ;;
        "Linux aarch64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-ARM64.tar.gz"
          SHA="${LINUX_ARM64_SHA} trivy.tgz"
          ;;
        "Darwin x86_64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_macOS-64bit.tar.gz"
          SHA="${MACOS_X86_64_SHA} trivy.tgz"
          ;;
        "Darwin arm64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_macOS-ARM64.tar.gz"
          SHA="${MACOS_ARM64_SHA} trivy.tgz"
          ;;
        *)
          echo "Unsupported machine: ${OPTARG}"
          exit 1
          ;;
      esac

      curl -o trivy.tgz -fsSL "${BINARY_URL}"
      echo "${SHA}" | sha256sum --check

      tar --no-same-owner -zxf trivy.tgz trivy
      rm trivy.tgz
      chmod +x trivy

steps:
  - scan:
      command:
        environment:
          NO_COLOR: "true"
          TRIVY_ADDITIONAL_ARGS: ${TRIVY_ADDITIONAL_ARGS---ignore-unfixed}
        run: |
          $SETUP_PATH/trivy fs --cache-dir=/tmp/trivy/ --format=cyclonedx --license-full --no-progress --scanners vuln . 2>&1
      format: cyclonedx
      post-processor:
        docker:
          image: public.ecr.aws/boostsecurityio/boost-scanner-trivy-sbom:dcc6f5c@sha256:3cf4ee0319f6ebe729e831d743a227332c12d62941df9f6d3eb21db441d8d8c5
          command: process
          environment:
            PYTHONIOENCODING: utf-8
