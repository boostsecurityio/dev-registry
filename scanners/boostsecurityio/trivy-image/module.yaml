api_version: 1.0

id: boostsecurityio/trivy-image
name: Trivy (Image scanning)
namespace: boostsecurityio/trivy-image
scan_types:
  - secrets
  - sca_container

config:
  require_full_repo: true
  support_diff_scan: true

setup:
  - name: download trivy
    environment:
      VERSION: 0.67.2
      LINUX_X86_64_SHA: 546511a5514afc813c0b72e4abeea2c16a32228a13a1e5114d927c190e76b1f9
      LINUX_ARM64_SHA: e4f28390b06cdaaed94f8c49cce2c4c847938b5188aefdeb82453f2e933e57cb
      MACOS_X86_64_SHA: 4a5b936a8d89b508ecdc6edd65933b6fe3e9a368796cbdf917fd0df393f26542
      MACOS_ARM64_SHA: 6b3163667f29fc608a2ed647c1bd42023af5779349286148190a168c5b3f28f1
    run: |
      BINARY_URL="https://github.com/aquasecurity/trivy/releases/download/v${VERSION}"
      ARCH=$(uname -m)

      case "$(uname -sm)" in
        "Linux x86_64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-64bit.tar.gz"
          SHA="${LINUX_X86_64_SHA} trivy.tgz"
          ;;
        "Linux aarch64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-ARM64.tar.gz"
          SHA="${LINUX_ARM64_SHA} trivy.tgz"
          ;;
        "Darwin x86_64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_macOS-64bit.tar.gz"
          SHA="${MACOS_X86_64_SHA} trivy.tgz"
          ;;
        "Darwin arm64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_macOS-ARM64.tar.gz"
          SHA="${MACOS_ARM64_SHA} trivy.tgz"
          ;;
        *)
          echo "Unsupported machine: ${OPTARG}"
          exit 1
          ;;
      esac

      curl -o trivy.tgz -fsSL "${BINARY_URL}"
      echo "${SHA}" | sha256sum --check

      tar --no-same-owner -zxf trivy.tgz trivy
      rm trivy.tgz
      chmod +x trivy

steps:
  - scan:
      command:
        environment:
          IMAGE_NAME: ${BOOST_IMAGE_NAME}
          TRIVY_ADDITIONAL_ARGS: ${TRIVY_ADDITIONAL_ARGS---ignore-unfixed}
          TRIVY_DB_REPOSITORY: public.ecr.aws/aquasecurity/trivy-db:2,ghcr.io/aquasecurity/trivy-db:2
          TRIVY_JAVA_DB_REPOSITORY: public.ecr.aws/aquasecurity/trivy-java-db:1,ghcr.io/aquasecurity/trivy-java-db:1
          TRIVY_SCANNERS: vuln,secret
        run: >
          $SETUP_PATH/trivy image 
          ${TRIVY_ADDITIONAL_ARGS} 
          --format json 
          --scanners ${TRIVY_SCANNERS}
          --skip-version-check 
          --quiet 
          ${BOOST_IMAGE_NAME}
      format: sarif
      post-processor:
        docker:
          image: public.ecr.aws/boostsecurityio/boost-scanner-trivy:b990ceb@sha256:d4871661744790add629604c85b396458e54cec780ac881a5c3e4fa9fd1dde22
          command: process
          workdir: /code
          environment:
            PYTHONIOENCODING: utf-8
            DOCKERFILE_PATH: ${BOOST_DOCKERFILE_PATH:-}
