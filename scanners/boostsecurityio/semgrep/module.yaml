api_version: 1.0

id: boostsecurityio/semgrep
name: Semgrep
namespace: boostsecurityio/semgrep
scan_types:
  - sast

config:
  support_diff_scan: true
  include_files:
  - .semgrep/*

setup:
  - name: Validate rules
    environment:
      SEMGREP_RULES: ${SEMGREP_RULES:-https://assets.build.boostsecurity.io/semgrep-rules/stable/all-sast-rules.yml}
    run: |
      echo "SEMGREP_RULES set to: '$SEMGREP_RULES'"
      for rule in $SEMGREP_RULES; do
        case "$rule" in
          .semgrep/*|http://*|https://*)
            # valid rule token; do nothing
            ;;
          *)
            echo "Semgrep Community Rules cannot be used. Provide a URL or relative path to rules file or leave blank for Boost curated rules."
            exit 1
            ;;
        esac
      done

steps:
  - scan:
      command:
        docker:
          image: returntocorp/semgrep:1.139.0@sha256:e1e0cde346c758f755e1bd28fd0ea43cde9d523b59a040611a6bdde2f84bb3dd
          command: semgrep scan --oss-only --sarif --quiet --disable-version-check --metrics=off --no-git-ignore .
          workdir: /src
          environment:
            XDG_CONFIG_HOME: /tmp
            HOME: /tmp
            SEMGREP_RULES: ${SEMGREP_RULES:-https://assets.build.boostsecurity.io/semgrep-rules/stable/all-sast-rules.yml}
      format: sarif
      post-processor:
        run: |-
          mkdir -p /shared/boost_results
          cat /dev/stdin > /tmp/raw_results.sarif
          docker run -i --rm public.ecr.aws/boostsecurityio/boost-scanner-semgrep:57334c4@sha256:3873871210db82461972a6df2ec0494394f2a8ce37af1f2a702b195db230c63d process < /tmp/raw_results.sarif > /shared/boost_results/results.sarif
          cat /shared/boost_results/results.sarif
