api_version: 1.0

id: boostsecurityio/codeql
name: BoostSecurity CodeQL
namespace: boostsecurityio/codeql

config:
  support_diff_scan: true
  require_full_repo: true

setup:
  - name: Download CodeQL bundle
    run: |
      case "$CODEQL_LANGUAGE" in
        html|cpp|ruby|python|javascript|csv|csharp|xml|go|java|properties) ;;
        *) echo "Invalid value for CODEQL_LANGUAGE '$CODEQL_LANGUAGE'."
           echo "Supported languages are html, cpp, ruby, python, " \
                 "javascript, csv, csharp, xml, go, java, properties."
           exit 1;;
      esac

      curl -fsSL -O "https://github.com/github/codeql-action/releases/download/codeql-bundle-v2.13.4/codeql-bundle-linux64.tar.gz"

      echo "4de0b3f799a4f4fe98426046ff62e4684bd4711242547e552a22f645e60996d8  codeql-bundle-linux64.tar.gz" | sha256sum --check

      tar -xzf codeql-bundle-linux64.tar.gz

steps:
  - name: "Create CodeQL database"
    environment:
      CODEQL_LANGUAGE: ${CODEQL_LANGUAGE}
      CODEQL_CREATE_ARGS: ${CODEQL_CREATE_ARGS:-}
    run: |
      $SETUP_PATH/codeql/codeql database create \
        "--language=$CODEQL_LANGUAGE" \
        --no-calculate-baseline \
        --quiet \
        --threads=0 \
        --overwrite \
        $CODEQL_CREATE_ARGS \
        -- "../codeql-db"

  - scan:
      format: sarif
      command:
        environment:
          CODEQL_QUERY: ${CODEQL_QUERY:-}
          CODEQL_ANALYZE_ARGS: ${CODEQL_ANALYZE_ARGS:-}
        run: |
          $SETUP_PATH/codeql/codeql database analyze \
            --format=sarifv2.1.0 \
            --output=/dev/stdout \
            --no-print-diagnostics-summary \
            --no-print-metrics-summary \
            --no-debug-info \
            --logdir=/tmp \
            --quiet \
            --threads=0 \
            $CODEQL_ANALYZE_ARGS \
            -- "../codeql-db" $CODEQL_QUERY

      post-processor:
        docker:
          image: public.ecr.aws/boostsecurityio/boost-scanner-codeql:5d1ff3b@sha256:c65d0fd61472170fd37488d25703e8e0669034163b353c07ee41f83524a50462
          command: process
          environment:
            PYTHONIOENCODING: utf-8
