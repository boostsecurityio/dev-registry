api_version: 1.0

id: boostsecurityio/codeql
name: BoostSecurity CodeQL
namespace: boostsecurityio/codeql
scan_types:
  - sast

config:
  support_diff_scan: true
  require_full_repo: true

setup:
  - name: Config
    environment:
      CODEQL_LANGUAGE: ${CODEQL_LANGUAGE}
      CODEQL_CREATE_ARGS: ${CODEQL_CREATE_ARGS:-}
      CODEQL_QUERY: ${CODEQL_QUERY:-}
      CODEQL_ANALYZE_ARGS: ${CODEQL_ANALYZE_ARGS:-}
    run: |
      echo "CODEQL_LANGUAGE: '$CODEQL_LANGUAGE'"
      echo "CODEQL_CREATE_ARGS: '$CODEQL_CREATE_ARGS'"
      echo "CODEQL_QUERY: '$CODEQL_QUERY'"
      echo "CODEQL_ANALYZE_ARGS: '$CODEQL_ANALYZE_ARGS'"
  - name: Validate Configuration
    run: |
      case "$CODEQL_LANGUAGE" in
        html|cpp|ruby|python|javascript|csv|csharp|xml|go|java|properties) ;;
        *) echo "Invalid value for CODEQL_LANGUAGE '$CODEQL_LANGUAGE'."
           echo "Supported languages are html, cpp, ruby, python, " \
                 "javascript, csv, csharp, xml, go, java, properties."
           exit 1;;
      esac

steps:
  - name: "Create CodeQL database"
    docker:
      image: slef05/codeql:latest
      environment:
        CODEQL_LANGUAGE: ${CODEQL_LANGUAGE}
        CODEQL_CREATE_ARGS: ${CODEQL_CREATE_ARGS:-}
      command: codeql database create \
          "--language=$CODEQL_LANGUAGE" \
          --no-calculate-baseline \
          --quiet \
          --threads=0 \
          --overwrite \
          $CODEQL_CREATE_ARGS \
          -- "../codeql-db"
#    run: |
#      $SETUP_PATH/codeql/codeql database create \
#        "--language=$CODEQL_LANGUAGE" \
#        --no-calculate-baseline \
#        --quiet \
#        --threads=0 \
#        --overwrite \
#        $CODEQL_CREATE_ARGS \
#        -- "../codeql-db"
#    command:
#      docker:
#        image: slef05/codeql:latest
#        command: codeql database create \
#          "--language=$CODEQL_LANGUAGE" \
#          --no-calculate-baseline \
#          --quiet \
#          --threads=0 \
#          --overwrite \
#          $CODEQL_CREATE_ARGS \
#          -- "../codeql-db"
#        environment:
#          CODEQL_LANGUAGE: ${CODEQL_LANGUAGE}
#          CODEQL_CREATE_ARGS: ${CODEQL_CREATE_ARGS:-}

  - scan:
      format: sarif
      command:
        docker:
          image: slef05/codeql:latest
          command: codeql database analyze \
              --format=sarifv2.1.0 \
              --output=/dev/stdout \
              --no-print-diagnostics-summary \
              --no-print-metrics-summary \
              --no-debug-info \
              --logdir=/tmp \
              --quiet \
              --threads=0 \
              $CODEQL_ANALYZE_ARGS \
              -- "../codeql-db" $CODEQL_QUERY
          environment:
            CODEQL_QUERY: ${CODEQL_QUERY:-}
            CODEQL_ANALYZE_ARGS: ${CODEQL_ANALYZE_ARGS:-}

      post-processor:
        docker:
          image: public.ecr.aws/boostsecurityio/boost-scanner-codeql:74de82a@sha256:49c5895e8e43f34dafce91f90a8d1d542f66baa6ff7c67fa187bb49156e3568e
          command: process
          environment:
            PYTHONIOENCODING: utf-8
